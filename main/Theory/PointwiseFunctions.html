
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PETSc pointwise functions and PDE solvers &#8212; Underworld 3</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/customize.css?v=47e70012" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Theory/PointwiseFunctions';</script>
    <script src="../_static/font_button.js?v=3ec2d3a6"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linear Algebra" href="LinearAlgebra.html" />
    <link rel="prev" title="The Lagrangian-Particle FEM" href="FiniteElements.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../FrontPage.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/AuWorldEQ.jpg" class="logo__image only-light" alt="Underworld 3 - Home"/>
    <script>document.write(`<img src="../_static/AuWorldEQ.jpg" class="logo__image only-dark" alt="Underworld 3 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../FrontPage.html">
                    The Underworld Geodynamics Platform
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Instruction Manual</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Manual/Index.html">Introduction to Underworld 3</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Manual/Meshes.html">Meshes and model objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Manual/Swarms.html">Particle Swarms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Manual/VariablesAndFunctions.html">Underworld Variables</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Index.html">Underworld Theory Manual</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="MathematicalBackground.html">Mathematical Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="FiniteElements.html">The Lagrangian-Particle FEM</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">PETSc pointwise functions and PDE solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="LinearAlgebra.html">Linear Algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="NonLinear.html">Non Linear Methods</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Notebooks/Index.html">Index of Sample notebooks</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Readme.html">Solving the Poisson Equation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_Poisson_Gradient_Recovery.html">Poisson Equation with flux recovery</a></li>

<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_Poisson_Cartesian_Generic.html">Poisson Equation (generic)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_Poisson_Spherical.html">Steady state diffusion in a hollow sphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_DiffusionSLCN_Cartesian-NL.html">Nonlinear diffusion of a hot pipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_DiffusionSLCN_Cartesian.html">Linear diffusion of a hot pipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PoissonEquation/Ex_Poisson_Cartesian.html">Poisson Equation (simple)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-PorousFlow/Readme.html">Porous flow examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PorousFlow/Ex_Darcy_1D_benchmark.html">Darcy flow (1d) using xy coordinates to define permeability distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PorousFlow/Ex_Darcy_1D_benchmark-Swarm.html">Darcy flow (1d) using swarm variable to define permeability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-PorousFlow/Ex_Darcy_Cartesian.html">Underworld Groundwater Flow Benchmark 1</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Readme.html">Stokes Flow</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Swarm_Bubbles.html">Multiple materials - Drips and Blobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Cartesian_SolNL.html">Non-linear Stokes benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Sinker.html">Multiple materials - Linear stokes sinker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Cartesian_SolC.html">Stokes Benchmark SolCx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Disk_CylCoords.html">Cylindrical Stokes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Spherical_FreeSlipBCs.html">Stokes flow in a Spherical Domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Swarm_RT_Cartesian.html">Rayleigh Taylor - swarm materials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_Stokes_Swarm_RT_Spherical.html">Rayleigh-Taylor (Level-set based) in the sphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-StokesFlow/Ex_WIP_Stokes_Periodic.html">Periodic Mesh Example (WIP)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-Convection/Readme.html">Convection modelling examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_AdvectionDiffusionSLCN_RotationTest.html">Field (SemiLagrange) Advection solver test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_AdvectionDiffusionSwarm_RotationTest.html">Swarm Advection solver test - shear flow driven by a pre-defined, rigid body rotation in a disc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_1_SLCN_Cartesian.html">Constant viscosity convection, Cartesian domain (benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_2_SLCN_Cartesian-TdepVisc.html">Temperature-dependent viscosity convection, Cartesian Domain(benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_3_SLCN_Cylindrical-TdepVisc.html">Temperature-dependent viscosity convection, Cylindrical domain (benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_4_SLCN_Cartesian-NL.html">Non-linear viscosity convection, Cartesian domain (benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_5_SLCN_Cartesian-Yield.html">Non-linear viscosity convection, Cartesian domain (benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_Cartesian-Swarm.html">Constant viscosity convection, Cartesian domain (benchmark)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_Cartesian_ThermoChem.html">Thermochemical convection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_Cylinder.html">Stokes in a disc with adv_diff to solve T and back-in-time sampling with particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Convection/Ex_Convection_Disc_InternalHeat.html">Convection in a disc with internal heating and rigid or free boundaries</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-Sandbox-VEP/Readme.html">Visco-elastic-plastic models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Sandbox-VEP/Ex_Shear_Band_Notch_Benchmark.html">Spiegelman et al, notch-deformation benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Sandbox-VEP/Ex_Shear_Band_Plasticity_PS.html">Flow and Shear banding around a circular inclusion in pure shear</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Sandbox-VEP/Ex_Shear_Band_Plasticity_SS.html">Shear bands around a circular inclusion in a simple shear flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Sandbox-VEP/Ex_Sheared_Layer_Test.html">Validate constitutive models</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-NavierStokes/Readme.html">Navier Stokes Equation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-NavierStokes/Ex_NavierStokesRotationTest.html">Navier Stokes test: boundary driven ring with step change in boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-NavierStokes/Ex_Navier_Stokes_Disk_FreeSlipBCs-Coriolis.html">Cylindrical Stokes with Coriolis term (out of plane)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-NavierStokes/Ex_Navier_Stokes_Disk_NoSlipBCs-Coriolis_ss.html">Cylindrical Stokes with Coriolis term (out of plane)</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Notebooks/Examples-Utilities/Readme.html">Miscellaneous Tips and Tricks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Utilities/Ex_BCs_from_meshVariables.html">Cylindrical 2D Diffusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Utilities/Ex_Integrals_on_Meshes.html">Using the PETSc mesh integration routines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Utilities/Ex_Projection_Function_Eval.html">Projection-based function evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Notebooks/Examples-Utilities/Ex_Tensor_Variables_etc.html">Examples with General Mesh variable manipulation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/underworldcode/underworld3" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Theory/PointwiseFunctions.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>PETSc pointwise functions and PDE solvers</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#underworld-solver-classes">Underworld Solver Classes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-examples">Implementation &amp; Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-solvers">Poisson Solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advection-dominated-flow">Advection dominated flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incompressible-stokes">Incompressible Stokes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-the-poisson-equation">Example 1 - The Poisson Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-projections-and-evaluations">Example 2 - Projections and Evaluations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-incompressible-stokes-equation">Example 3 - Incompressible Stokes Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-advection-in-the-absence-of-diffusion">Example 4 - Advection in the absence of diffusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-the-scalar-advection-diffusion-equation">Example 5 - The Scalar Advection-diffusion Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-6-navier-stokes">Example 6 - Navier-Stokes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="petsc-pointwise-functions-and-pde-solvers">
<h1>PETSc pointwise functions and PDE solvers<a class="headerlink" href="#petsc-pointwise-functions-and-pde-solvers" title="Link to this heading">#</a></h1>
<p>As we saw in [the Finite Element Pages], the finite element method provides a very general way to approach the numerical solution of a very wide variety of problems in continuum mechanics using a standardised, matrix-based formulation and with considerable flexibility in the choice of discretisation, mesh geometry, and the ability to deal very naturally with jumps in material properties.</p>
<p>However, the FEM is based upon a variational, “weak” form of the governing equations of any problem while most publications outline the strong form of any problem and this can make it difficult for anyone without a strong mathematical background to translate quickly from publication to a new model.</p>
<p>PETSc provides a mechanism to automatically generate a finite element weak form from the strong (point-wise) form of the governing equations. This takes the form of a template equation and, in the case of non-linear problems, a template for the corresponding Jacobian derivatives.</p>
<p>The PETSc strong-form interface asks the user to provide pre-compiled functions with a pre-defined pattern of arguments relating known nodal-point variables, shape-functions and derivatives at any point in the domain.  If the strong form is written</p>
<div class="math notranslate nohighlight">
\[ \mathbf{F}(\mathbf{u}) \sim \nabla.\mathbf{f}_1(u, \nabla u) - f_0 (u, \nabla u) = 0 \]</div>
<p>Where the <span class="math notranslate nohighlight">\(f_0\)</span> term, generally speaking, represents the forces and <span class="math notranslate nohighlight">\(f_1\)</span> comprises flux terms.
Then a corresponding weak form is</p>
<div class="math notranslate nohighlight">
\[ \phi^T \mathbf{F}(\mathbf{u}) \sim \int_\Omega \phi \cdot f_0 \left(u, \nabla u \right) + 
                                                   \nabla \phi \mathbf{f}_1 \left(u, \nabla u \right) = 0 \]</div>
<p>The discrete form of this equation has some obvious similarities to the standard finite element matrix form except that the functions <span class="math notranslate nohighlight">\(f_0\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f}_1\)</span> are not directly expressed in terms of the basis function matrices:</p>
<div class="math notranslate nohighlight">
\[ \cal{F}(\cal{u}) \sim \sum_e \epsilon_e^T \left[ B^T W f_0(u^q, \nabla u^q) + 
                                                    \sum_k D_k^T W \mathbf{f}_1^k (u^q, \nabla u^q) \right] = 0 
\]</div>
<p>where <span class="math notranslate nohighlight">\(q\)</span> represents a set of quadrature points, <span class="math notranslate nohighlight">\(W\)</span> is a matrix of weights and <span class="math notranslate nohighlight">\(B\)</span>, <span class="math notranslate nohighlight">\(D\)</span> are the usual basis function matrices but here evaluated at the quadrature points. <span class="math notranslate nohighlight">\(\epsilon\)</span> restricts the terms to the element. See <span id="id1">[<a class="reference internal" href="../Bibliography.html#id3" title="Matthew G. Knepley, Jed Brown, Karl Rupp, and Barry F. Smith. Achieving High Performance with Unified Residual Evaluation. arXiv:1309.1204 [cs], September 2013. arXiv:1309.1204.">KBRS13</a>]</span> for details.</p>
<p>The user must provide a compiled representation of the terms <span class="math notranslate nohighlight">\(f_0\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f}_1\)</span> but it is also necessary to provide the corresponding compiled representations of the Jacobians which satisfy</p>
<div class="math notranslate nohighlight">
\[\begin{split} \cal{F'}(\cal{u}) \sim \sum_e \epsilon_e^T 
                \left[ \begin{array}{cc}
                    B^T  &amp; \mathbf{D}^T \\
                \end{array} \right]
                \mathbf{W}
                \left[ \begin{array}{cc} 
                    f_{0,0} &amp; f_{0,1} \\
                    \mathbf{f}_{1,0} &amp; \mathbf{f}_{1,1} \\
                \end{array}\right]
                 \left[ \begin{array}{c}
                    B^T  \\ 
                    \mathbf{D}^T 
                \end{array} \right] \epsilon_e
\quad \mathrm{and} \quad
                f_{[i,j]} = 
                \left[ \begin{array}{cc} 
                    \partial f_0 / \partial u &amp; \partial f_0 / \partial \nabla u \\
                    \partial \mathbf{f}_1 / \partial u &amp; \partial \mathbf{f}_1 / \partial \nabla u
                \end{array}\right]
\end{split}\]</div>
<p>This formulation greatly simplifies writing optimal code as the user sets up a problem without touching the bulk of the implementation. The only difficulty is ensuring that the Jacobians are derived consistently and correctly. As the Jacobians need to be calculated and implemented as separate functions this introduces a potential point of failure.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">underworld</span></code>, we provide a fully symbolic approach to specifying the strong form terms, <span class="math notranslate nohighlight">\(f_0\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f}_1\)</span> using the <code class="docutils literal notranslate"><span class="pre">sympy</span></code> symbolic algebra python package. <code class="docutils literal notranslate"><span class="pre">sympy</span></code> is also able to differentiate
<span class="math notranslate nohighlight">\(f_0\)</span> and <span class="math notranslate nohighlight">\(\mathbf{f}_1\)</span> to obtain the relevant Jacobian matrices in symbolic form. We also take
advantage of <code class="docutils literal notranslate"><span class="pre">sympy</span></code>s automatic code generation capabilities to compile functions that match
the PETSc templates.</p>
<p>This provides a very natural mapping between the formulation above and the <code class="docutils literal notranslate"><span class="pre">sympy</span></code> python code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
        <span class="c1"># X and U are sympy position vector, unknown vector </span>
        <span class="c1"># that may include mesh variables </span>
 
        <span class="n">U_grad</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="n">F0</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">U_grad</span>

        <span class="c1"># Jacobians are </span>

        <span class="n">J_00</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">F0</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">J_01</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">F0</span><span class="p">,</span> <span class="n">U_grad</span><span class="p">)</span>
        <span class="n">J_10</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">F1</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="n">J_11</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">F1</span><span class="p">,</span> <span class="n">U_grad</span><span class="p">)</span>

        <span class="c1"># Pass F0, F1, J_xx to sympy code generation routines</span>

        <span class="c1"># ...</span>

</pre></div>
</div>
<p>Note: some re-indexing may be necessary to interface between <code class="docutils literal notranslate"><span class="pre">sympy</span></code> and PETSc
especially for vector problems.</p>
<p>Note: underworld provides a translation between mesh variables and their <code class="docutils literal notranslate"><span class="pre">sympy</span></code>
symbolic representation on the user-facing side that also needs to translate
to PETSc data structures in the compiled code.</p>
<section id="underworld-solver-classes">
<h2>Underworld Solver Classes<a class="headerlink" href="#underworld-solver-classes" title="Link to this heading">#</a></h2>
<p>We provide 3 base classes to build solvers. These are a scalar SNES solver,
a vector SNES solver and a Vector SNES saddle point solver (constrained vector problem).
These are bare-bones classes that implement the pointwise function / sympy approach that
can then be used to build solvers for many common situations.</p>
<p>A blank slate is a very scary thing and so we provide templates for some common equations
and examples to show how these can be extended.</p>
</section>
<section id="implementation-examples">
<h2>Implementation &amp; Examples<a class="headerlink" href="#implementation-examples" title="Link to this heading">#</a></h2>
<section id="poisson-solvers">
<h3>Poisson Solvers<a class="headerlink" href="#poisson-solvers" title="Link to this heading">#</a></h3>
<p>(link to another document)
Diffusion</p>
<p>Darcy flow</p>
<p>Advection-diffusion (SLCN)</p>
</section>
<section id="advection-dominated-flow">
<h3>Advection dominated flow<a class="headerlink" href="#advection-dominated-flow" title="Link to this heading">#</a></h3>
<p>(link to another document)</p>
<p>Swarm-based problems</p>
<p>Projection / swarm evaluation</p>
<p>Advection-diffusion (Swarm)</p>
<p>Material point methods</p>
</section>
<section id="incompressible-stokes">
<h3>Incompressible Stokes<a class="headerlink" href="#incompressible-stokes" title="Link to this heading">#</a></h3>
<p>(link to another document)</p>
<p>Saddle point problems</p>
<p>Stokes, boundary conditions, constraints</p>
<p>Navier-Stokes (Swarm)</p>
<p>Viscoelasticity</p>
</section>
</section>
<section id="remarks">
<h2>Remarks<a class="headerlink" href="#remarks" title="Link to this heading">#</a></h2>
<p>The generic solver classes can be used to construct all of the examples above. The equation-system classes that we provide help to provide a template or scaffolding for a less experienced user and they also help to orchestrate cases where multiple solvers come together in a specific order (e.g. the Navier-Stokes case where history variable
projections need to be evaluated during the solve).</p>
<p>Creating sub-classes from the equation systems or the generic solvers is an excellent way to build workflows whenever there is a risk of exposing some fragile construction at the user level.</p>
<p>Some of the need for these templates is a result of inconsistencies in the way <code class="docutils literal notranslate"><span class="pre">sympy</span></code> treats matrices, vectors and tensor (array) objects. We expect this to change over time.</p>
</section>
<section id="example-1-the-poisson-equation">
<h2>Example 1 - The Poisson Equation<a class="headerlink" href="#example-1-the-poisson-equation" title="Link to this heading">#</a></h2>
<p>The classical form of the scalar Poisson Equation is</p>
<div class="math notranslate nohighlight">
\[ \alpha \nabla^2 \psi = f \]</div>
<p>Where <span class="math notranslate nohighlight">\(\psi\)</span> is an unknown scalar quantity, <span class="math notranslate nohighlight">\(\alpha\)</span> is
a constitutive parameter that relates gradients to fluxes, and <span class="math notranslate nohighlight">\(f\)</span>
is a source term.</p>
<p>This equation is obtained by considering the divergence of fluxes needed to
balance the sources. For example, in thermal diffusion we identify
<span class="math notranslate nohighlight">\(\psi\)</span> with the temperature, <span class="math notranslate nohighlight">\(T\)</span>, and the constitutive parameter, <span class="math notranslate nohighlight">\(k\)</span>,
is a thermal conductivity.</p>
<div class="math notranslate nohighlight">
\[ \nabla \cdot k \nabla T = h \]</div>
<p>In this form, <span class="math notranslate nohighlight">\(\mathbf{q} = k \nabla T\)</span> is Fourier’s expression of the
heat flux in terms of temperature gradients.This form matches the template above if we identify:</p>
<div class="math notranslate nohighlight">
\[ f_0 = -h \quad \textrm{and} \quad f_1 = k\nabla T\]</div>
<p>and, in fact, this is exactly what we need to specify in the underworld equation
system.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="n">solver</span><span class="o">.</span><span class="n">L</span><span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># f0 residual term (weighted integration) - scalar function</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">F0</span> <span class="o">=</span> <span class="o">-</span><span class="n">h</span>

        <span class="c1"># f1 residual term (integration by parts / gradients)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">F1</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">solver</span><span class="o">.</span><span class="n">L</span>
</pre></div>
</div>
<p>which means the user only needs to supply a mesh, a mesh variable to
hold the solution and sympy expressions for <span class="math notranslate nohighlight">\(k\)</span> and <span class="math notranslate nohighlight">\(h\)</span> in order
to solve a Poisson equation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SNES_Poisson</span></code> class is a very lightweight wrapper on
the <code class="docutils literal notranslate"><span class="pre">SNES_Scalar</span></code> class which provides a template for the flux
term and very little else.
<span class="math notranslate nohighlight">\(F_0\)</span> and <span class="math notranslate nohighlight">\(F_1\)</span> are inherited as an empty scalar and vector respectively.
These are available in the template for the user to extend the equation as needed.</p>
<p><a class="reference internal" href="#../Notebooks/Ex_Poisson_Cartesian_Generic"><span class="xref myst">This notebook</span></a> compares
the generic class and the one with the flux templated.</p>
</section>
<section id="example-2-projections-and-evaluations">
<h2>Example 2 - Projections and Evaluations<a class="headerlink" href="#example-2-projections-and-evaluations" title="Link to this heading">#</a></h2>
<p>PETSc has a very general concept of discretisation spaces that do not
necessarily admit to continuous interpolation to or from arbitrary points.
For this reason, a more general concept is to create projections that map
between representations of the data. For example, in Finite Elements,
fluxes are generally not available at nodal points because shape functions
have discontinuous gradients there. To compute fluxes at nodal points, we
would establish a projection problem to form a best fitting continous function
to the values at points where we can evaluate the fluxes. In addition,
sympy functions (including those for fluxes) that contain derivatives of finite element variables
can not be evaluated numerically by sympy but can be evaluated as compiled
functions in the context of a solver.</p>
<p>We write these evaluations using the <code class="docutils literal notranslate"><span class="pre">Projection</span></code> solver classes. This is
the simplest of the solvers and we are only discussing it second because it
is almost too simple to be instructive (and because the weak form of this
equation is the natural one to work with).</p>
<p>We would like to solve for a continuous, nodal point solution <span class="math notranslate nohighlight">\(u\)</span> that
satisfies as best possible,</p>
<div class="math notranslate nohighlight">
\[ \int_\Omega \phi u d\Omega = \int_\Omega \phi \tilde{u} d\Omega \]</div>
<p>where <span class="math notranslate nohighlight">\(\tilde{u}\)</span> is a function with unknown continuity that we
are able to evaluate at integration points in the mesh.</p>
<p>The generic solver specification in underworld looks like this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
        <span class="c1"># f0 residual term (weighted integration) - scalar function</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">F0</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">fn</span> <span class="o">-</span> <span class="n">user_uw_function</span>

        <span class="c1"># f1 residual term (integration by parts / gradients)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">F1</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">user_uw_function</span></code> is some sympy expression in terms of spatial
coordinates that can include mesh or swarm variables. <code class="docutils literal notranslate"><span class="pre">solver.u.fn</span></code> is the
mesh variable (in function form) where the solution will reside.</p>
<p>In principle we could add a smoothing term via <code class="docutils literal notranslate"><span class="pre">solver.F1</span></code> and, importantly,
we can also add boundary conditions or constraints that need to be satisfied in
addition to fitting the integration point values.</p>
<p>We provide projection operators for scalar fields, vector fields and
solenoidal vector fields (ensuring that the projection remains divergence free). These
provide templates for the <span class="math notranslate nohighlight">\(F_0\)</span> and <span class="math notranslate nohighlight">\(F_1\)</span> terms with generic smoothing.
For an explanation of the divergence free projection methodology, see the next
example on the incompressible Stokes problem.</p>
<p><a class="reference internal" href="#../Notebooks/Ex_Project_Function.md"><span class="xref myst">This notebook</span></a> has an example of
each of these cases.</p>
</section>
<section id="example-3-incompressible-stokes-equation">
<h2>Example 3 - Incompressible Stokes Equation<a class="headerlink" href="#example-3-incompressible-stokes-equation" title="Link to this heading">#</a></h2>
<p>The incompressible Stokes Equation is an example of a problem with an
additional constraint equation that must be satisfied by the solution.
Variational formulations (the weak form of
classical finite elements is one) naturally lend themselves
to the addition of multiple constraints into the functional to be minimised.</p>
<p>Unfortunately, the incompressiblity constraint needs to be enforced very strongly
to obtain reasonable solutions and this can lead to unacceptably
ill conditioned systems that are slow or impossible to solve.</p>
<p>Alternatively, we solve a coupled problem in which additional, kinematic,
parameters of the constraint term are introduced. This forms a new block system of
equations that is a general expression for a large range of constrained problems.</p>
<p>These are often known as <em>saddle point problems</em> which represents the trade-off
between satisfying the original equations and the constraint equations.
(Saddle point here refers to the curvature of the functional we are
optimising) See: M. Benzi, G. Golub and J. Liesen,
Numerical solution of saddle point problems, Acta Numerica 14 (2005),
pp. 1–137. for a general discussion.</p>
<p>The coupled equation system we want to solve is</p>
<div class="math notranslate nohighlight">
\[ \nabla \cdot \mathbf{\tau} - \nabla p = f_\textrm{buoy} \]</div>
<p>with the constraint</p>
<div class="math notranslate nohighlight">
\[ \nabla \cdot \mathbf{u} = 0 \]</div>
<p>The saddle-point solver requires us to specify both of these equations and
to provide two solution vectors <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{p}\)</span>. In this
system, <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> is the parameter that enforces the incompressiblity
constraint equation and is physically identifiable as a pressure.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
        <span class="c1"># definitions </span>

        <span class="n">U_grad</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="n">strainrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad</span><span class="p">)</span> <span class="o">+</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">stress</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">viscosity</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">strainrate</span>

        <span class="c1"># set up equation terms</span>

        <span class="c1"># u f0 residual term (weighted integration) - vector function</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">UF0</span> <span class="o">=</span> <span class="o">-</span> <span class="n">solver</span><span class="o">.</span><span class="n">bodyforce</span>

        <span class="c1"># u f1 residual term (integration by parts / gradients) - tensor (sympy.array) term</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">UF1</span> <span class="o">=</span> <span class="n">stress</span>

        <span class="c1"># p f0 residual term (these are the constraints) - vector function</span>

        <span class="n">solver</span><span class="o">.</span><span class="n">PF0</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">divergence</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">underworld</span></code>, the <code class="docutils literal notranslate"><span class="pre">SNES_Stokes</span></code> solver class is responsible for managing the
user interface to the saddle point system for incompressible Stokes flow.</p>
</section>
<section id="example-4-advection-in-the-absence-of-diffusion">
<h2>Example 4 - Advection in the absence of diffusion<a class="headerlink" href="#example-4-advection-in-the-absence-of-diffusion" title="Link to this heading">#</a></h2>
<p>The pure transport equation can be written in Lagrangian</p>
<div class="math notranslate nohighlight">
\[ \frac{D \psi}{D t} = 0 \]</div>
<p>or in Eulerian form</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial \psi}{\partial t} + \mathbf{u} \cdot \nabla \psi = 0 \]</div>
<p>In the Lagrangian form, there is nothing to solve, provided the fluid-transported reference frame is available. In the Eulerian form, the non-linear <em>advection</em> term
<span class="math notranslate nohighlight">\(\mathbf{u} \cdot \nabla \psi\)</span> is reknowned for being difficult to solve, especially in the pure-transport form.</p>
<p>Underworld provides discrete Lagrangian <code class="docutils literal notranslate"><span class="pre">swarm</span></code> variables [ CROSSREF ] that make it straightforward to work with transported quantities
on a collection of moving sample points that we normally refer to as <em>particles</em>.
Behind the scenes, there is complexity in 1) following the Lagrangian reference frame accurately,
2) mapping the fluid-deformed reference frame to the stationary mesh, and 3) for
parallel meshes, migrating particles (and their data) across the decomposed domain.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">swarm</span></code> that manages the variables is able to update the locations of the particles
when provided with a velocity vector field and a time increment and will handle the
particle re-distribution in the process.</p>
<p>Each variable on a swarm has a corresponding mesh variable (a <em>proxy</em> variable) that
is automatically updated when the particle locations change. The proxy variable is
computed through a projection (see above).</p>
<p><em>Note:</em> If specific boundary conditions need to be applied, it is necessary for the user
to define their own projection operator, apply the boundary conditions, and solve when needed.
(<em>Feature request: allow user control over the projection, including
boundary conditions / constraints, so that this is not part of the user’s responsibility</em>)</p>
</section>
<section id="example-5-the-scalar-advection-diffusion-equation">
<h2>Example 5 - The Scalar Advection-diffusion Equation<a class="headerlink" href="#example-5-the-scalar-advection-diffusion-equation" title="Link to this heading">#</a></h2>
<p>The situation where a quantity is diffusing through a moving fluid.</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial \psi}{\partial t} + \mathbf{u}\cdot\nabla\psi = \nabla \cdot \alpha \nabla \psi + f\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> is a (velocity) vector that transports <span class="math notranslate nohighlight">\(\psi\)</span> and <span class="math notranslate nohighlight">\(\alpha\)</span> is a
diffusivity. In Lagrangian form (following <span class="math notranslate nohighlight">\(\mathbf{u}\)</span>),</p>
<div class="math notranslate nohighlight">
\[ \frac{D \psi}{D t} = \nabla \cdot \alpha \nabla \psi + f\]</div>
<p>As before, the advection terms are greatly simplified in a Lagrangian reference
frame but now we also have diffusion terms and boundary conditions that are easy
to solve accurately in an Eulerian mesh but which must also be applied to variables
that derive from a Lagrangian swarm (which has no boundary conditions of its own).</p>
<p>Advection-diffusion equations are often dominated by the presence of boundary layers where
advection of a quantity (along the direction of flow) is balanced by a diffusive flux
in the cross-stream direction. Under these conditions, there is some work to be done to
ensure that these two terms are calculated consistently and this is particularly important
close to regions where boundary conditions need to be applied.</p>
<p>The approach in <code class="docutils literal notranslate"><span class="pre">underworld</span></code> is to provide a solver structure to manage
advection-diffusion problems on behalf of the user. We use
a swarm-variable for tracking the history of the <span class="math notranslate nohighlight">\(\psi\)</span> as it is transported
by <span class="math notranslate nohighlight">\(\mathbf{u}\)</span> and we allow the user to specify (solve for) this flow, and
to update the swarm positions accordingly. The history variable, <span class="math notranslate nohighlight">\(\psi^*\)</span>
is the value of <span class="math notranslate nohighlight">\(\psi\)</span> upstream at an earlier timestep and allows us to
approximate <span class="math notranslate nohighlight">\(D \psi/Dt\)</span> as a finite difference approximation along the
characteristics of the advection operator:</p>
<div class="math notranslate nohighlight">
\[\left. \frac{D \psi}{Dt} \right|_{p} \approx \frac{\psi_p - \psi^*_p}{\Delta t}\]</div>
<p>Here, the subscript <span class="math notranslate nohighlight">\(p\)</span> indicates a value at a particle in the Lagrangian swarm.</p>
<p>This approach leads to a very natural problem description in python that corresponds closely to the mathematical formulation, namely:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="n">solver</span><span class="o">.</span><span class="n">L</span>     <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">,</span>      <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">Lstar</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U_star</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># f0 residual term</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">_f0</span> <span class="o">=</span> <span class="o">-</span><span class="n">solver</span><span class="o">.</span><span class="n">f</span> <span class="o">+</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">fn</span> <span class="o">-</span> <span class="n">solver</span><span class="o">.</span><span class="n">U_star</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span> <span class="o">/</span> <span class="n">solver</span><span class="o">.</span><span class="n">delta_t</span>

        <span class="c1"># f1 residual term (backward Euler)  </span>
        <span class="n">solver</span><span class="o">.</span><span class="n">_f1</span> <span class="o">=</span>  <span class="n">solver</span><span class="o">.</span><span class="n">L</span> <span class="o">*</span> <span class="n">solver</span><span class="o">.</span><span class="n">k</span>

        <span class="c1">## OR </span>

        <span class="c1"># f1 residual term (Crank-Nicholson)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">_f1</span> <span class="o">=</span>  <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span> <span class="n">solver</span><span class="o">.</span><span class="n">Lstar</span><span class="p">)</span> <span class="o">*</span> <span class="n">solver</span><span class="o">.</span><span class="n">k</span>
</pre></div>
</div>
<p>In the above, the <code class="docutils literal notranslate"><span class="pre">U_star</span></code> variable is a projection of the Lagrangian history variable
<span class="math notranslate nohighlight">\(\psi^*_p\)</span> onto the mesh <em>subject to the same boundary conditions as</em> <span class="math notranslate nohighlight">\(\psi\)</span>.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">SNES_AdvectionDiffusion_Swarm</span></code> class (which is derived from <code class="docutils literal notranslate"><span class="pre">SNES_Poisson</span></code>),
the <code class="docutils literal notranslate"><span class="pre">solve</span></code> method solves for <code class="docutils literal notranslate"><span class="pre">U_star</span></code> using an in-built projection and boundary
conditions copied from the parent, before calling a standard Poisson solver. This class manages every aspect of the creation, refresh and solution of the necessary
projection subroutines Lagrangian history term, but not the update of this variable or the advection.</p>
<p><em>Caveat emptor:</em> In the Crank-Nicholson stiffness matrix terms above, we form the derivatives in both the flux and the flux history with the same operator where, strictly, we should transport the derivatives (or form derivatives with respect to the transported coordinate system).</p>
</section>
<section id="example-6-navier-stokes">
<h2>Example 6 - Navier-Stokes<a class="headerlink" href="#example-6-navier-stokes" title="Link to this heading">#</a></h2>
<p>The incompressible Navier-Stokes equation of fluid dynamics is essentially the vector equivalent of the
scalar advection-diffusion equation above, in which the transported quantity is the velocity (strictly momentum) vector that is also responsible for the transport.</p>
<div class="math notranslate nohighlight">
\[ \rho \frac{\partial \mathbf{u}}{\partial t} + \mathbf{u}\cdot\nabla\mathbf{u} = \nabla \cdot \eta \left( \nabla \mathbf{u} + \nabla \mathbf{u}^T \right)/2 + \rho \mathbf{g}\]</div>
<div class="math notranslate nohighlight">
\[ \nabla \cdot \mathbf{u} = 0 \]</div>
<p>Obviously this is a strongly non-linear problem, but simply introduce the time dependence to the Stokes equation in the same way as we did for the Poisson equation above. A finite difference representation of the Lagrangian derivative of the velocity is defined using a vector swarm variable</p>
<div class="math notranslate nohighlight">
\[\left. \frac{D \mathbf{u}}{Dt} \right|_{p} \approx \frac{\mathbf{u}_p - \mathbf{u}^*_p}{\Delta t}\]</div>
<p>And the python problem description becomes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="c1"># definitions </span>

        <span class="n">U_grad</span>      <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">,</span>     <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">U_grad_star</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">derive_by_array</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">Ustar</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="n">strainrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad</span><span class="p">)</span> <span class="o">+</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">stress</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">viscosity</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">strainrate</span>

        <span class="n">strainrate_star</span> <span class="o">=</span> <span class="p">(</span><span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad_star</span><span class="p">)</span> <span class="o">+</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">U_grad_star</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">stress_star</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">viscosity</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">strainrate_star</span>

        <span class="c1"># set up equation terms</span>

        <span class="c1"># u f0 residual term (weighted integration) - vector function</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">UF0</span> <span class="o">=</span> <span class="o">-</span> <span class="n">solver</span><span class="o">.</span><span class="n">bodyforce</span> <span class="o">+</span> <span class="n">solver</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">fn</span> <span class="o">-</span> <span class="n">solver</span><span class="o">.</span><span class="n">U_star</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span> <span class="o">/</span> <span class="n">solver</span><span class="o">.</span><span class="n">delta_t</span>

        <span class="c1"># u f1 residual term (integration by parts / gradients) - tensor (sympy.array) term</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">UF1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">stress</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">stress_star</span>

        <span class="c1"># p f0 residual term (these are the constraints) - vector function</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">PF0</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">divergence</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
<p>Note, again, that, formulated in this way, the stress and strain-rate history variables neglect terms resulting from the deformation of the coordinate system over the timestep, <span class="math notranslate nohighlight">\(\Delta t\)</span>. We could instead transport the strain rate or stress</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Theory"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="FiniteElements.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Lagrangian-Particle FEM</p>
      </div>
    </a>
    <a class="right-next"
       href="LinearAlgebra.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Linear Algebra</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#underworld-solver-classes">Underworld Solver Classes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-examples">Implementation &amp; Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-solvers">Poisson Solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advection-dominated-flow">Advection dominated flow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incompressible-stokes">Incompressible Stokes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-the-poisson-equation">Example 1 - The Poisson Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-projections-and-evaluations">Example 2 - Projections and Evaluations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-incompressible-stokes-equation">Example 3 - Incompressible Stokes Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-4-advection-in-the-absence-of-diffusion">Example 4 - Advection in the absence of diffusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-5-the-scalar-advection-diffusion-equation">Example 5 - The Scalar Advection-diffusion Equation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-6-navier-stokes">Example 6 - Navier-Stokes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Louis Moresi
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>